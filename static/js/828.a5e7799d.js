"use strict";(self.webpackChunkjira_time_tracker=self.webpackChunkjira_time_tracker||[]).push([[828],{26828:(e,s,t)=>{t.d(s,{TasksPage:()=>ee,loaderTasks:()=>ae});var a=t(60235),r=t(42708),i=t(59908),n=t(82792),o=t(67294),l=t(2321),d=t(13191),c=t(74064),u=t(81083),m=t(10769),g=t(91304);const h={color:"white",classNames:{root:"bg-[var(--mantine-color-error)]",title:"text-[var(--mantine-color-default)]",description:"text-[var(--mantine-color-default)]",closeButton:"text-[var(--mantine-color-default)] hover:bg-[var(--mantine-color-dark-outline)]"}},j=()=>(0,d.C)({queryKey:["tasks tracking"],queryFn:async e=>{const s=m.j.getState().getIssueIdsSearchParams();if(s){return(await Promise.allSettled(s.split(",").map((s=>u.b.get("/issue",{params:{id:s},signal:e.signal}))))).reduce(((e,s)=>{if("fulfilled"===s.status&&e.push(s.value.data),"rejected"===s.status){var t,a;const e=s.reason;m.j.getState().changeIssueIdsSearchParams("delete",s.reason.config.params.id),g.N9.show({title:"Issue ".concat(null===(t=e.config)||void 0===t?void 0:t.params.id),message:null===(a=e.response)||void 0===a?void 0:a.data.errorMessages.join(", "),...h})}return e}),[])}return[]}}),p=()=>(0,c.t)({queryKey:["tasks"],queryFn:async e=>{const s=m.j.getState().getIssueIdsSearchParams(),t=await u.b.get("/tasks",{params:{jql:m.j.getState().jql,startAt:20*e.pageParam,maxResults:20},signal:e.signal});return{...t.data,issues:t.data.issues.filter((e=>!s.includes(e.id)))}},getNextPageParam:(e,s,t,a)=>e.issues.length>0?t+1:null,initialPageParam:0});var v=t(85893);const f=()=>{const{ref:e,inView:s}=(0,r.YD)(),{isLoading:t,isFetching:a,isFetchingNextPage:d,hasNextPage:c,fetchNextPage:u}=(0,i.N)(p());return(0,o.useEffect)((()=>{s&&!a&&u()}),[s,a]),!t&&(0,v.jsxs)(n.z,{variant:"light",color:"blue",onClick:()=>u(),fullWidth:!0,children:[d?"Loading more...":c?"Load More":"Nothing more to load",(0,v.jsx)("span",{ref:e,className:(0,l.cn)("invisible",{hidden:d})})]})},x=(0,o.memo)(f);var y=t(21760),k=t(40327);const b=async e=>{const s=await u.b.post("/jql-search",{includeCollapsedFields:!0},{params:{url:e}});return{jqlFields:s.data.visibleFieldNames,jqlFunctions:s.data.visibleFunctionNames}},w=async e=>(await u.b.get("/jql-search",{params:{url:e}})).data;var I=t(30202),N=t(96205);const S=e=>{const{className:s}=e,t=(0,I.NL)(),a=(0,m.j)((e=>e.jql)),{mutate:r,isPending:i}=(0,N.D)({mutationFn:()=>u.b.put("/filter-details",{jql:m.j.getState().jql},{params:{id:m.j.getState().filterId}}),onMutate:()=>{t.invalidateQueries({queryKey:["tasks"]})},onError:e=>{var s;g.N9.show({title:"Error loading issue",message:null===(s=e.response)||void 0===s?void 0:s.data.errorMessages.join(", "),...h})}}),n=(0,k.R)("autocomplete",b,w);return(0,v.jsx)("div",{className:(0,l.cn)("mb-[1.5rem] [&_div_div:nth-child(1)]:bg-[var(--mantine-color-default)]",s),children:(0,v.jsx)(y.L,{isSearching:i,analyticsSource:"autocomplete",query:a,onSearch:(e,s)=>{0===s.errors.length&&s.represents!==m.j.getState().jql&&(m.j.getState().updateJQL(e),r())},autocompleteProvider:n,locale:"en"})})},q=(0,o.memo)(S);var P=t(78551),C=t(29855),F=t(85453),D=t(36209),Q=t(39448),M=t(14260),_=t(84714),E=t(56485),K=t(2276);const L=e=>{const s=Math.floor(e/60),t=Math.floor(s/60);return"".concat(String(t).padStart(2,"0"),":").concat(String(s%60).padStart(2,"0"))};var T=t(80830),Z=t(89341);const z=e=>{const{id:s,onChange:t,children:a,position:r="bottom-start",disabled:i}=e,[n,l]=(0,o.useState)(!1),{data:d,isLoading:c}=(0,P.a)({queryKey:["statuses task",s],queryFn:()=>u.b.get("/statuses-task",{params:{id:s}}),select:e=>e.data,enabled:n});return(0,v.jsxs)(T.v,{shadow:"md",onChange:i?void 0:l,position:r,disabled:i,children:[(0,v.jsx)(T.v.Target,{children:a}),(0,v.jsxs)(T.v.Dropdown,{children:[c&&Array.from({length:5},((e,s)=>(0,v.jsx)(T.v.Item,{children:(0,v.jsx)(Z.O,{w:100,h:20,bg:"cyan.6"})},s))),!c&&(null==d?void 0:d.transitions.map((e=>(0,v.jsx)(T.v.Item,{onClick:()=>t(e),value:e.name,children:e.name},e.id))))]})]})};var U=t(93513);const A=e=>{const{id:s,queryKey:t,children:a,position:r,disabled:i,idxPage:n,idxIssue:o,onChange:l}=e,d=(0,I.NL)(),{mutate:c}=(0,N.D)({mutationFn:e=>u.b.post("/change-status-task",{taskId:s,transitionId:e.id}),onMutate:async e=>(await d.cancelQueries({queryKey:[t]}),d.setQueryData([t],(s=>Array.isArray(s)?(0,U.Uy)(s,(s=>{s[o].fields.status=e.to})):(0,U.Uy)(s,(s=>{s.pages[n].issues[o].fields.status=e.to})))),"function"==typeof l&&l(),d.getQueryData([t])),onError:(e,a,r)=>{var i;g.N9.show({title:"Error issue ".concat(s),message:null===(i=e.response)||void 0===i?void 0:i.data.errorMessages.join(", "),...h}),d.setQueryData([t],r)}});return(0,v.jsx)(z,{id:s,position:r,disabled:i,onChange:e=>c(e),children:a})};var O=t(27484),W=t.n(O);const B=()=>{const[e,s]=(0,o.useState)(W()().startOf("day")),t=e.format("HH:mm:ss");return(0,o.useEffect)((()=>{let e;return e=setInterval((()=>{s((e=>e.add(1,"second")))}),1e3),()=>clearInterval(e)}),[]),(0,v.jsx)(Q.C,{mb:10,size:"xl",radius:"sm",variant:"filled",children:t})},H=e=>{const{taskId:s}=e,[t,a]=(0,o.useState)(!1),r=(0,I.NL)(),i=(0,N.D)({mutationFn:e=>e.id?u.b.put("/worklog-task",e):u.b.post("/worklog-task",e),onMutate:()=>{r.setQueryData(["tasks tracking"],(e=>(0,U.Uy)(e,(e=>{const t=e.find((e=>e.id===s));t&&(t.fields.timespent+=60)}))))}}),n=(0,P.a)({queryKey:["worklog",s],queryFn:async()=>{const e=await u.b.get("/worklog-task",{params:{id:s}}),t=r.getQueryData(["login"]);if(t){var a;const r=e.data.worklogs.find((e=>e.author.accountId==t.accountId&&W()(e.started).isToday())),n=(e=>{const s=Math.floor(e/28800);e%=28800;const t=Math.floor(e/3600);e%=3600;const a=Math.floor(e/60);return"".concat(s,"d ").concat(t,"h ").concat(a,"m")})((null!==(a=null==r?void 0:r.timeSpentSeconds)&&void 0!==a?a:0)+60);r?i.mutate({taskId:s,timeSpent:n,id:r.id}):i.mutate({taskId:s,timeSpent:n})}return!0},refetchInterval:6e4,refetchOnWindowFocus:!1,gcTime:0,enabled:t,notifyOnChangeProps:["error"]});(0,o.useEffect)((()=>{const e=setTimeout((()=>{a(!0)}),6e4);return()=>clearTimeout(e)}),[]),(0,o.useEffect)((()=>{var e;n.error&&g.N9.show({title:"Error worklog issue",message:null===(e=n.error.response)||void 0===e?void 0:e.data.errorMessages.join(", "),...h})}),[n]),(0,o.useEffect)((()=>{var e;i.error&&g.N9.show({title:"Error worklog issue",message:null===(e=i.error.response)||void 0===e?void 0:e.data.errorMessages.join(", "),...h})}),[i.error])},J=e=>{const{fields:s,id:t,idxIssue:r}=e,i=(0,I.NL)(),[l,d]=(0,o.useState)(!1);H({taskId:t});return(0,v.jsxs)(C.Z,{shadow:"sm",radius:"md",bg:"teal.0",mb:"sm",withBorder:!0,children:[(0,v.jsx)(B,{}),(0,v.jsxs)(F.Z,{mb:10,justify:"space-between",children:["indeterminate"!==s.status.statusCategory.key&&(0,v.jsx)(D.b,{className:"w-[100%]",variant:"light",color:"red",title:"Warning!",icon:(0,v.jsx)(E.Z,{}),children:'This task is not in the "In progress" status please change its status. However, time continues to be logged for it.'}),(0,v.jsx)(a.D,{order:5,children:s.summary}),(0,v.jsxs)(Q.C,{color:"blue",className:"flex-row",children:[(0,v.jsx)("span",{className:"mr-[0.5rem]",children:L(s.timespent)}),(0,v.jsx)("span",{className:"mr-[0.5rem]",children:"/"}),(0,v.jsx)("span",{children:L(s.timeoriginalestimate)})]})]}),(0,v.jsxs)(F.Z,{justify:"space-between",children:[(0,v.jsx)(A,{id:t,idxIssue:r,queryKey:"tasks tracking",children:(0,v.jsx)(n.z,{variant:"outline",size:"xs",children:s.status.name})}),l?(0,v.jsx)(M.a,{size:"sm"}):(0,v.jsx)(_.A,{variant:"light",children:(0,v.jsx)(K.Z,{onClick:async()=>{m.j.getState().changeIssueIdsSearchParams("delete",t),d(!0),await i.cancelQueries({queryKey:["tasks"]}),await i.invalidateQueries({queryKey:["tasks"]}),i.setQueryData(["tasks tracking"],(e=>(0,U.Uy)(e,(e=>{e.splice(r,1)})))),d(!1)},className:"cursor-pointer [&_path]:fill-[var(--mantine-color-violet-5)]"})})]})]},t)},R=(0,o.memo)(J),V=()=>{const{data:e}=(0,P.a)(j());return(0,v.jsx)(v.Fragment,{children:null==e?void 0:e.map(((e,s)=>(0,v.jsx)(R,{idxIssue:s,fields:e.fields,id:e.id},e.id)))})};var Y=t(87311);const G=e=>{const{fields:s,id:t,idxPage:r,idxIssue:i}=e,o=(0,I.NL)(),l=()=>{m.j.getState().changeIssueIdsSearchParams("add",t),o.setQueryData(["tasks tracking"],(e=>{const s=o.getQueryData(["tasks"]);return(0,U.Uy)(e,(e=>{s&&e.unshift(s.pages[r].issues[i])}))})),o.setQueryData(["tasks"],(e=>(0,U.Uy)(e,(e=>{e.pages[r].issues.splice(i,1)}))))};return(0,v.jsxs)(C.Z,{shadow:"sm",radius:"md",mb:"sm",withBorder:!0,children:[(0,v.jsxs)(F.Z,{mb:10,justify:"space-between",children:[(0,v.jsx)(a.D,{order:5,children:s.summary}),(0,v.jsxs)(Q.C,{color:"blue",className:"flex-row",children:[(0,v.jsx)("span",{className:"mr-[0.5rem]",children:L(s.timespent)}),(0,v.jsx)("span",{className:"mr-[0.5rem]",children:"/"}),(0,v.jsx)("span",{children:L(s.timeoriginalestimate)})]})]}),(0,v.jsxs)(F.Z,{justify:"space-between",children:[(0,v.jsx)(A,{id:t,idxPage:r,idxIssue:i,queryKey:"tasks",children:(0,v.jsx)(n.z,{variant:"outline",size:"xs",children:s.status.name})}),(0,v.jsx)(A,{id:t,idxPage:r,idxIssue:i,queryKey:"tasks",position:"left",onChange:()=>l(),disabled:"indeterminate"===s.status.statusCategory.key,children:(0,v.jsx)(Y.Z,{className:"cursor-pointer [&_path]:fill-[var(--mantine-color-violet-5)]",..."indeterminate"===s.status.statusCategory.key&&{onClick:l}})})]})]},t)},X=(0,o.memo)(G),$=()=>{const{data:e,error:s}=(0,i.N)(p());return(0,o.useEffect)((()=>{var e;s&&g.N9.show({title:"Error loading task",message:null===(e=s.response)||void 0===e?void 0:e.data.errorMessages.join(", "),...h})}),[s]),(0,v.jsx)(v.Fragment,{children:null==e?void 0:e.pages.map(((e,s)=>e.issues.map(((e,t)=>(0,v.jsx)(X,{idxPage:s,idxIssue:t,fields:e.fields,id:e.id},e.id)))))})},ee=()=>(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)(a.D,{mb:10,order:2,children:"Tasks"}),(0,v.jsx)(q,{}),(0,v.jsx)(V,{}),(0,v.jsx)($,{}),(0,v.jsx)(x,{})]}),se="___TimeTracking___";var te=t(29204);const ae=e=>async()=>{let s="";try{const t=await u.b.get("/filters",{params:{filterValue:se}});if(t.data.values.length>0){const e=t.data.values[0].id,a=await u.b.get("/filter-details",{params:{id:e}});m.j.getState().setFilterId(e),s=a.data.jql}else{s=(await u.b.post("/filter-details",{name:se,description:"",jql:""})).data.jql}m.j.getState().updateJQL(s),e.prefetchInfiniteQuery(p()),e.prefetchQuery(j())}catch(e){var t;if(e instanceof te.d7)g.N9.show({title:"When the page loads",message:null===(t=e.response)||void 0===t?void 0:t.data.errorMessages.join(", "),...h})}return!0}}}]);