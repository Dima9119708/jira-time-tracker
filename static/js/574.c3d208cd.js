"use strict";(self.webpackChunkjira_time_tracker=self.webpackChunkjira_time_tracker||[]).push([[574],{17574:(e,s,a)=>{a.d(s,{ErrorBoundary:()=>ce,IssuesPage:()=>re,loaderIssues:()=>oe});var t=a(60235),i=a(42708),r=a(59908),n=a(82792),o=a(67294),l=a(2321),d=a(13191),c=a(74064),u=a(50214),g=a(52821),m=a(91304),h=a(73049);const y=()=>(0,c.t)({queryKey:["tasks"],queryFn:async e=>{const s=g.j.getState().getIssueIdsSearchParams(),a=await u.b.get("/tasks",{params:{jql:g.j.getState().jql,startAt:20*e.pageParam,maxResults:20},signal:e.signal});return{...a.data,issues:a.data.issues.filter((e=>!s.includes(e.id)))}},getNextPageParam:(e,s,a,t)=>e.issues.length>0?a+1:null,initialPageParam:0});var j=a(85893);const p=()=>{const{ref:e,inView:s}=(0,i.YD)(),{isLoading:a,isFetching:t,isFetchingNextPage:d,hasNextPage:c,fetchNextPage:u}=(0,r.N)(y());return(0,o.useEffect)((()=>{s&&!t&&u()}),[s,t]),!a&&(0,j.jsxs)(n.z,{variant:"light",color:"blue",onClick:()=>u(),fullWidth:!0,children:[d?"Loading more...":c?"Load More":"Nothing more to load",(0,j.jsx)("span",{ref:e,className:(0,l.cn)("invisible",{hidden:d})})]})},v=(0,o.memo)(p);var x=a(21760),f=a(40327);const k=async e=>{const s=await u.b.post("/jql-search",{includeCollapsedFields:!0},{params:{url:e}});return{jqlFields:s.data.visibleFieldNames,jqlFunctions:s.data.visibleFunctionNames}},I=async e=>(await u.b.get("/jql-search",{params:{url:e}})).data;var N=a(30202),S=a(96205),b=a(88198),w=a(88565);const C=e=>{const{className:s}=e,a=(0,N.NL)(),t=(0,g.j)((e=>e.jql)),{mutate:i,isPending:r}=(0,S.D)({mutationFn:()=>u.b.put("/filter-details",{jql:g.j.getState().jql},{params:{id:g.j.getState().filterId}}),onMutate:()=>{const e=m.N9.show({title:"Searching",message:"",loading:!0});a.invalidateQueries({queryKey:["tasks"]}).then((()=>{m.N9.update({id:e,title:"Searching",message:"",icon:(0,j.jsx)(b.Z,{style:{width:(0,w.h)(18),height:(0,w.h)(18)}}),loading:!1,autoClose:h.u})})).catch((()=>{m.N9.hide(e)}))},onError:e=>{var s;m.N9.show({title:"Error loading issue",message:JSON.stringify(null===(s=e.response)||void 0===s?void 0:s.data),...h.y.ERROR})}}),n=(0,f.R)("autocomplete",k,I);return(0,j.jsx)("div",{className:(0,l.cn)("mb-[1.5rem] [&_div_div:nth-child(1)]:bg-[var(--mantine-color-default)]",s),children:(0,j.jsx)(x.L,{isSearching:r,analyticsSource:"autocomplete",query:t,onSearch:(e,s)=>{0===s.errors.length&&s.represents!==g.j.getState().jql&&(g.j.getState().updateJQL(e),i())},autocompleteProvider:n,locale:"en"})})},q=(0,o.memo)(C);var P=a(78551),E=a(29855),K=a(85453),D=a(36209),R=a(39448),F=a(32543),Q=a(14260),U=a(84714),z=a(56485),Z=a(2276);const O=e=>{const s=Math.floor(e/60),a=Math.floor(s/60);return"".concat(String(a).padStart(2,"0"),":").concat(String(s%60).padStart(2,"0"))};var L=a(27602),_=a(89341);const M=e=>{const{issueId:s,onChange:a,children:t,status:i,position:r="bottom-start",disabled:n}=e,[d,c]=(0,o.useState)(!1),{data:g,isLoading:m}=(0,P.a)({queryKey:["statuses task",s],queryFn:()=>u.b.get("/statuses-task",{params:{id:s}}),select:e=>e.data,enabled:d});return(0,j.jsxs)(L.v,{shadow:"md",onChange:n?void 0:c,position:r,disabled:n,children:[(0,j.jsx)(L.v.Target,{children:t}),(0,j.jsxs)(L.v.Dropdown,{children:[m&&Array.from({length:5},((e,s)=>(0,j.jsx)(L.v.Item,{children:(0,j.jsx)(_.O,{w:100,h:20,bg:"cyan.6"})},s))),!m&&(null==g?void 0:g.transitions.map((e=>(0,j.jsx)(L.v.Item,{onClick:()=>a(e),value:e.name,className:(0,l.cn)({"bg-[var(--mantine-color-dark-light)]":i.id===e.to.id}),children:e.name},e.id))))]})]})};var A=a(93513);const T=e=>{const{issueId:s,queryKey:a,children:t,status:i,issueName:r,position:n,disabled:o,idxPage:l,idxIssue:d,onChange:c}=e,g=(0,N.NL)(),{mutate:y}=(0,S.D)({mutationFn:e=>u.b.post("/change-status-task",{taskId:s,transitionId:e.id}),onMutate:async e=>{await g.cancelQueries({queryKey:[a]}),g.setQueryData([a],(s=>Array.isArray(s)?(0,A.Uy)(s,(s=>{s[d].fields.status=e.to})):(0,A.Uy)(s,(s=>{s.pages[l].issues[d].fields.status=e.to})))),"function"==typeof c&&c();const s="from ".concat(i.name," to ").concat(e.name);return{notificationId:m.N9.show({title:"Status changes",message:s,loading:!0}),notificationMessage:s,oldState:g.getQueryData([a])}},onSuccess:(e,s,a)=>{m.N9.update({id:a.notificationId,autoClose:h.u,loading:!1,icon:(0,j.jsx)(b.Z,{style:{width:(0,w.h)(18),height:(0,w.h)(18)}}),message:a.notificationMessage})},onError:(e,s,t)=>{var i;m.N9.hide(t.notificationId),m.N9.show({title:"Error issue ".concat(r),message:JSON.stringify(null===(i=e.response)||void 0===i?void 0:i.data),...h.y.ERROR}),g.setQueryData([a],t.oldState)}});return(0,j.jsx)(M,{issueId:s,status:i,position:n,disabled:o,onChange:e=>y(e),children:t})};var J=a(27484),H=a.n(J);const W=(e,s)=>{const a=(0,o.useRef)({pause:!1,seconds:0}),[t,i]=(0,o.useState)(H()().startOf("day")),r=t.format("HH:mm:ss");return a.current.seconds=3600*t.hour()+60*t.minute()+t.second(),(0,o.useEffect)((()=>{let e;return e=setInterval((()=>{a.current.pause||i((e=>e.add(1,"second")))}),1e3),()=>clearInterval(e)}),[]),(0,o.useImperativeHandle)(s,(()=>({pause:()=>{a.current.pause=!0},play:()=>{a.current.pause=!1},setIntervalTrigger:(e,s)=>{let t=e;const r=setInterval((()=>{a.current.seconds!==t||a.current.pause||(t+=e,s())}),1e3);return()=>{i(H()().startOf("day")),clearInterval(r)}}}))),(0,j.jsx)(R.C,{mb:10,size:"xl",radius:"sm",variant:"filled",children:r})},B=(0,o.forwardRef)(W);var V=a(8861);const Y=e=>{var s,a;const{issueKey:t,assignee:i,onChange:r,children:n,position:d="bottom-start"}=e,[c,g]=(0,o.useState)(!1),{data:m,isLoading:h}=(0,P.a)({queryKey:["assignable issue",t],queryFn:()=>u.b.get("/issue-assignable",{params:{id:t}}),select:e=>[...e.data,{accountId:null,displayName:"Unassigned",avatarUrls:void 0}].sort(((e,s)=>e.displayName.localeCompare(s.displayName))),enabled:c});return(0,j.jsxs)(L.v,{shadow:"md",onChange:g,position:d,children:[(0,j.jsx)(L.v.Target,{children:n({name:null!==(s=null==i?void 0:i.displayName)&&void 0!==s?s:"Unassigned",ImageComponent:null!=i&&null!==(a=i.avatarUrls)&&void 0!==a&&a["48x48"]?(0,j.jsx)(F.E,{h:20,w:20,loading:"lazy",src:i.avatarUrls["48x48"]}):(0,j.jsx)(V.Z,{height:23,width:23,color:"black"})})}),(0,j.jsxs)(L.v.Dropdown,{children:[h&&Array.from({length:5},((e,s)=>(0,j.jsx)(L.v.Item,{children:(0,j.jsx)(_.O,{w:100,h:20,bg:"cyan.6"})},s))),!h&&(null==m?void 0:m.map((e=>{var s;return(0,j.jsx)(L.v.Item,{onClick:()=>r(e),className:(0,l.cn)({"bg-[var(--mantine-color-dark-light)]":e.accountId===(null==i?void 0:i.accountId)}),value:e.displayName,leftSection:null!=e&&null!==(s=e.avatarUrls)&&void 0!==s&&s["48x48"]?(0,j.jsx)(F.E,{h:20,w:20,loading:"lazy",src:e.avatarUrls["48x48"]}):(0,j.jsx)(V.Z,{height:23,width:23,color:"black"}),children:e.displayName},e.accountId)})))]})]})},G=e=>{const{issueKey:s,idxIssue:a,issueName:t,idxPage:i,assignee:r,children:n,queryKey:o,position:l="bottom-start"}=e,d=(0,N.NL)(),{mutate:c}=(0,S.D)({mutationFn:e=>u.b.put("/issue-assignee",{accountId:e.accountId},{params:{id:s}}),onMutate:async e=>{var s;await d.cancelQueries({queryKey:[o]}),d.setQueryData([o],(s=>Array.isArray(s)?(0,A.Uy)(s,(s=>{s[a].fields.assignee=e})):(0,A.Uy)(s,(s=>{s.pages[i].issues[a].fields.assignee=e}))));const t="from ".concat(null!==(s=null==r?void 0:r.displayName)&&void 0!==s?s:"Unassigned"," to ").concat(e.displayName),n=m.N9.show({title:"Assignee changes",message:t,loading:!0});return{oldState:d.getQueryData([o]),notificationId:n,notificationMessage:t}},onSuccess:(e,s,a)=>{m.N9.update({id:a.notificationId,autoClose:h.u,loading:!1,icon:(0,j.jsx)(b.Z,{style:{width:(0,w.h)(18),height:(0,w.h)(18)}}),message:a.notificationMessage})},onError:(e,s,a)=>{var i;m.N9.hide(a.notificationId),m.N9.show({title:'Error issue "'.concat(t,'"'),message:JSON.stringify(null===(i=e.response)||void 0===i?void 0:i.data),...h.y.ERROR}),d.setQueryData([o],a.oldState)}});return(0,j.jsx)(Y,{assignee:r,issueKey:s,onChange:c,position:l,children:n})},X=e=>{const{fields:s,id:a,idxIssue:i,issueKey:r}=e,l=(0,N.NL)(),[d,c]=(0,o.useState)(!1),y=(e=>{const{taskId:s}=e,a=(0,N.NL)(),t=(0,o.useRef)(null),i=(0,g.j)((e=>e.settings.timeLoggingInterval.second)),r=(0,g.j)((e=>e.isSystemIdle)),n=(0,S.D)({mutationFn:e=>e.id?u.b.put("/worklog-task",e):u.b.post("/worklog-task",e),onMutate:()=>(a.setQueryData(["tasks tracking"],(e=>(0,A.Uy)(e,(e=>{const a=e.find((e=>e.id===s));a&&(a.fields.timespent+=i)})))),{oldState:a.getQueryData(["tasks tracking"])}),onError:(e,s,t)=>{var i;a.setQueryData(["tasks tracking"],t.oldState),m.N9.show({title:"Error worklog issue",message:JSON.stringify(null===(i=e.response)||void 0===i?void 0:i.data),...h.y.ERROR})}}),l=(0,P.a)({queryKey:["worklog",s],queryFn:async()=>{const e=await u.b.get("/worklog-task",{params:{id:s}}),t=a.getQueryData(["login"]);if(t){var r;const a=e.data.worklogs.find((e=>e.author.accountId==t.accountId&&H()(e.started).isToday())),o=(null!==(r=null==a?void 0:a.timeSpentSeconds)&&void 0!==r?r:0)+i;a?n.mutate({taskId:s,timeSpentSeconds:o,id:a.id}):n.mutate({taskId:s,timeSpentSeconds:o})}return!0},gcTime:0,enabled:!1,notifyOnChangeProps:["error"]});return(0,o.useEffect)((()=>{var e;return null===(e=t.current)||void 0===e?void 0:e.setIntervalTrigger(i,l.refetch)}),[i]),(0,o.useEffect)((()=>{var e,s;r?null===(e=t.current)||void 0===e||e.pause():null===(s=t.current)||void 0===s||s.play()}),[r]),t})({taskId:a}),p=async()=>{c(!0),await g.j.getState().changeIssueIdsSearchParams("delete",a),await l.invalidateQueries({queryKey:["tasks"]}),l.setQueryData(["tasks tracking"],(e=>(0,A.Uy)(e,(e=>{const s=e.findIndex((e=>e.id===a));e.splice(s,1)})))),c(!1)};return(0,j.jsxs)(E.Z,{shadow:"sm",radius:"md",bg:"teal.0",mb:"sm",withBorder:!0,children:[(0,j.jsx)(B,{ref:y}),(0,j.jsxs)(K.Z,{mb:10,justify:"space-between",children:[!d&&"indeterminate"!==s.status.statusCategory.key&&(0,j.jsx)(D.b,{className:"w-[100%]",variant:"light",color:"red",title:"Warning!",icon:(0,j.jsx)(z.Z,{}),children:'This task is not in the "In progress" status please change its status. However, time continues to be logged for it.'}),(0,j.jsx)(t.D,{order:5,children:s.summary}),(0,j.jsxs)(R.C,{color:"blue",className:"flex-row",children:[(0,j.jsx)("span",{className:"mr-[0.5rem]",children:O(s.timespent)}),(0,j.jsx)("span",{className:"mr-[0.5rem]",children:"/"}),(0,j.jsx)("span",{children:O(s.timeoriginalestimate)})]})]}),(0,j.jsxs)(K.Z,{mb:10,children:[(0,j.jsxs)(R.C,{size:"md",variant:"light",leftSection:(0,j.jsx)(F.E,{height:18,width:18,loading:"lazy",className:"rounded",src:s.project.avatarUrls["32x32"]}),children:["Project: ",s.project.name]}),(0,j.jsxs)(R.C,{variant:"light",leftSection:(0,j.jsx)(F.E,{height:18,width:18,loading:"lazy",className:"rounded",src:s.priority.iconUrl}),children:["priority: ",s.priority.name]}),(0,j.jsxs)(R.C,{variant:"light",children:["key: ",r]})]}),(0,j.jsxs)(K.Z,{justify:"space-between",children:[(0,j.jsxs)(K.Z,{children:[(0,j.jsx)(T,{issueId:a,issueName:s.summary,status:s.status,idxIssue:i,queryKey:"tasks tracking",children:(0,j.jsx)(n.z,{variant:"outline",size:"xs",children:s.status.name})}),(0,j.jsx)(G,{assignee:s.assignee,issueName:s.summary,issueKey:r,idxIssue:i,queryKey:"tasks tracking",children:e=>{let{name:s,ImageComponent:a}=e;return(0,j.jsx)(n.z,{variant:"outline",size:"xs",leftSection:a,children:s})}})]}),d?(0,j.jsx)(Q.a,{size:"sm"}):(0,j.jsx)(T,{issueId:a,issueName:s.summary,status:s.status,idxIssue:i,queryKey:"tasks tracking",onChange:p,disabled:"done"===s.status.statusCategory.key,children:(0,j.jsx)(U.A,{variant:"light",..."done"===s.status.statusCategory.key&&{onClick:p},children:(0,j.jsx)(Z.Z,{className:"cursor-pointer [&_path]:fill-[var(--mantine-color-violet-5)]"})})})]})]},a)},$=(0,o.memo)(X),ee=()=>{const{data:e}=(0,P.a)((0,d.C)({queryKey:["tasks tracking"],queryFn:async e=>{const s=g.j.getState().getIssueIdsSearchParams();return s?(await Promise.allSettled(s.split(",").map((s=>u.b.get("/issue",{params:{id:s},signal:e.signal}))))).reduce(((e,s)=>{if("fulfilled"===s.status&&e.push(s.value.data),"rejected"===s.status){var a,t;const e=s.reason;g.j.getState().changeIssueIdsSearchParams("delete",s.reason.config.params.id),m.N9.show({title:"Issue ".concat(null===(a=e.config)||void 0===a?void 0:a.params.id),message:null===(t=e.response)||void 0===t?void 0:t.data.errorMessages.join(", "),...h.y.ERROR})}return e}),[]):[]}}));return(0,j.jsx)(j.Fragment,{children:null==e?void 0:e.map(((e,s)=>(0,j.jsx)($,{issueKey:e.key,idxIssue:s,fields:e.fields,id:e.id},e.id)))})};var se=a(87311);const ae=e=>{const{fields:s,id:a,idxPage:i,idxIssue:r,issueKey:o}=e,l=(0,N.NL)(),d=()=>{g.j.getState().changeIssueIdsSearchParams("add",a),l.setQueryData(["tasks tracking"],(e=>{const s=l.getQueryData(["tasks"]);return(0,A.Uy)(e,(e=>{s&&e.unshift(s.pages[i].issues[r])}))})),l.setQueryData(["tasks"],(e=>(0,A.Uy)(e,(e=>{e.pages[i].issues.splice(r,1)}))))};return(0,j.jsxs)(E.Z,{shadow:"sm",radius:"md",mb:"sm",withBorder:!0,children:[(0,j.jsxs)(K.Z,{mb:10,justify:"space-between",children:[(0,j.jsx)(t.D,{order:5,children:s.summary}),(0,j.jsxs)(R.C,{color:"blue",className:"flex-row",children:[(0,j.jsx)("span",{className:"mr-[0.5rem]",children:O(s.timespent)}),(0,j.jsx)("span",{className:"mr-[0.5rem]",children:"/"}),(0,j.jsx)("span",{children:O(s.timeoriginalestimate)})]})]}),(0,j.jsxs)(K.Z,{mb:10,children:[(0,j.jsxs)(R.C,{size:"md",variant:"light",leftSection:(0,j.jsx)(F.E,{height:18,width:18,loading:"lazy",className:"rounded",src:s.project.avatarUrls["32x32"]}),children:["Project: ",s.project.name]}),(0,j.jsxs)(R.C,{variant:"light",leftSection:(0,j.jsx)(F.E,{height:18,width:18,loading:"lazy",className:"rounded",src:s.priority.iconUrl}),children:["priority: ",s.priority.name]}),(0,j.jsxs)(R.C,{variant:"light",children:["key: ",o]})]}),(0,j.jsxs)(K.Z,{justify:"space-between",children:[(0,j.jsxs)(K.Z,{children:[(0,j.jsx)(T,{issueId:a,issueName:s.summary,status:s.status,idxPage:i,idxIssue:r,queryKey:"tasks",children:(0,j.jsx)(n.z,{variant:"outline",size:"xs",children:s.status.name})}),(0,j.jsx)(G,{assignee:s.assignee,issueName:s.summary,issueKey:o,idxPage:i,idxIssue:r,queryKey:"tasks",children:e=>{let{name:s,ImageComponent:a}=e;return(0,j.jsx)(n.z,{variant:"outline",size:"xs",leftSection:a,children:s})}})]}),(0,j.jsx)(T,{issueId:a,issueName:s.summary,status:s.status,idxPage:i,idxIssue:r,queryKey:"tasks",position:"left",onChange:()=>d(),disabled:"indeterminate"===s.status.statusCategory.key,children:(0,j.jsx)(se.Z,{className:"cursor-pointer [&_path]:fill-[var(--mantine-color-violet-5)]",..."indeterminate"===s.status.statusCategory.key&&{onClick:d}})})]})]},a)},te=(0,o.memo)(ae),ie=()=>{const{data:e,error:s}=(0,r.N)(y());return(0,o.useEffect)((()=>{var e;s&&m.N9.show({title:"Error loading task",message:JSON.stringify(null===(e=s.response)||void 0===e?void 0:e.data),...h.y.ERROR})}),[s]),(0,j.jsx)(j.Fragment,{children:null==e?void 0:e.pages.map(((e,s)=>e.issues.map(((e,a)=>(0,j.jsx)(te,{issueKey:e.key,idxPage:s,idxIssue:a,fields:e.fields,id:e.id},e.id)))))})},re=()=>(0,j.jsxs)(j.Fragment,{children:[(0,j.jsx)(t.D,{mb:10,order:2,children:"Issues"}),(0,j.jsx)(q,{}),(0,j.jsx)(ee,{}),(0,j.jsx)(ie,{}),(0,j.jsx)(v,{})]}),ne="___TimeTracking___",oe=async()=>{let e="";const[s,a]=await Promise.all([u.b.get("/filters",{params:{filterValue:ne}}),u.b.get("/configuration-timetracking")]);if(s.data.values.length>0){const a=s.data.values[0].id,t=await u.b.get("/filter-details",{params:{id:a}});g.j.getState().setFilterId(a),g.j.getState().parseAndSaveSetting(t.data.description),e=t.data.jql}else{e=(await u.b.post("/filter-details",{name:ne,description:"",jql:""})).data.jql}return g.j.getState().updateJQL(e),g.j.getState().setWorkHoursPerWeek(a.data.workingHoursPerDay),!0};var le=a(89250),de=a(17010);const ce=()=>{var e,s,a,t;const i=(0,le.lk)();return(0,j.jsx)("div",{className:"h-[100%] flex items-center justify-center",children:(0,j.jsx)(D.b,{variant:"light",color:"red",title:"Status error - ".concat(null===(e=i.response)||void 0===e?void 0:e.status),icon:(0,j.jsx)(de.Z,{}),children:null!==(s=null===(a=i.response)||void 0===a||null===(a=a.data)||void 0===a||null===(a=a.errorMessages)||void 0===a?void 0:a.join(", "))&&void 0!==s?s:JSON.stringify(null===(t=i.response)||void 0===t?void 0:t.data)})})}}}]);