"use strict";(self.webpackChunkjira_time_tracker=self.webpackChunkjira_time_tracker||[]).push([[611],{3611:(e,s,t)=>{t.d(s,{TasksPage:()=>$,loaderTasks:()=>se});var a=t(60235),i=t(42708),r=t(59908),n=t(82792),l=t(67294),c=t(2321),d=t(13191),o=t(74064),u=t(81083),m=t(28447);const g=(0,m.M)(((e,s)=>({filterId:"",jql:"",setFilterId:s=>{e((e=>{e.filterId=s}))},getSearchParamsIds:()=>{const e=new URL(document.URL).searchParams.get("keysTaskTracking");return null!=e?e:""},updateJQL:t=>{const a=new URL(document.URL).searchParams.get("keysTaskTracking"),i=((e,s)=>{if(s){const t="NOT key in (".concat(s,")");return e.includes("NOT key in")?e.replace(/NOT\skey\s+in\s+\(\d+(,\s*\d+)*\)/,t).trim():e.trim().length>0?"".concat(t," AND ").concat(e.trim()):t}return e.replace(/NOT\skey\s+in\s+\(\d+(,\s*\d+)*\)\s*AND/g,"").replace(/NOT\skey\s+in\s+\(\d+(,\s*\d+)*\)/g,"").trim()})(null!=t?t:s().jql,a);return e((e=>{e.jql=i})),i}})),{name:"Global Store"}),h=()=>(0,d.C)({queryKey:["tasks tracking"],queryFn:async e=>{const s=g.getState().getSearchParamsIds();if(s){const t=s.split(",").length+1;return(await u.b.get("/tracking-tasks",{params:{jql:"id in (".concat(s,")"),startAt:0,maxResults:t},signal:e.signal})).data}return{issues:[]}}}),p=()=>(0,o.t)({queryKey:["tasks"],queryFn:async e=>(await u.b.get("/tasks",{params:{jql:g.getState().jql,startAt:20*e.pageParam,maxResults:20},signal:e.signal})).data,getNextPageParam:(e,s,t,a)=>e.issues.length>0?t+1:null,initialPageParam:0});var j=t(85893);const y=()=>{const{ref:e,inView:s}=(0,i.YD)(),{isLoading:t,isFetching:a,isFetchingNextPage:d,hasNextPage:o,fetchNextPage:u}=(0,r.N)(p());return(0,l.useEffect)((()=>{s&&!a&&u()}),[s,a]),!t&&(0,j.jsxs)(n.z,{variant:"light",color:"blue",onClick:()=>u(),fullWidth:!0,children:[d?"Loading more...":o?"Load More":"Nothing more to load",(0,j.jsx)("span",{ref:e,className:(0,c.cn)("invisible",{hidden:d})})]})},x=(0,l.memo)(y);var k=t(21760),f=t(40327);const v=async e=>{const s=await u.b.post("/jql-search",{includeCollapsedFields:!0},{params:{url:e}});return{jqlFields:s.data.visibleFieldNames,jqlFunctions:s.data.visibleFunctionNames}},b=async e=>(await u.b.get("/jql-search",{params:{url:e}})).data;var q=t(30202),N=t(96205);const S=e=>{const{className:s}=e,t=(0,q.NL)(),a=g((e=>e.jql)),{mutate:i,isPending:r}=(0,N.D)({mutationFn:()=>u.b.put("/filter-details",{jql:g.getState().jql},{params:{id:g.getState().filterId}}),onMutate:()=>{t.invalidateQueries({queryKey:["tasks"]})}}),n=(0,f.R)("autocomplete",v,b);return(0,j.jsx)("div",{className:(0,c.cn)("mb-[1.5rem] [&_div_div:nth-child(1)]:bg-[var(--mantine-color-default)]",s),children:(0,j.jsx)(k.L,{isSearching:r,analyticsSource:"autocomplete",query:a,onSearch:(e,s)=>{0===s.errors.length&&s.represents!==g.getState().jql&&(g.getState().updateJQL(e),i())},autocompleteProvider:n,locale:"en"})})},w=(0,l.memo)(S);var I=t(78551),P=t(79655),T=t(29855),C=t(85453),L=t(36209),Q=t(39448),F=t(14260),D=t(84714),_=t(56485),K=t(2276);const O=e=>{const s=Math.floor(e/60),t=Math.floor(s/60);return"".concat(String(t).padStart(2,"0"),":").concat(String(s%60).padStart(2,"0"))};var U=t(80830),Z=t(89341);const z=e=>{const{id:s,onChange:t,children:a,position:i="bottom-start",disabled:r}=e,[n,c]=(0,l.useState)(!1),{data:d,isLoading:o}=(0,I.a)({queryKey:["statuses task",s],queryFn:()=>u.b.get("/statuses-task",{params:{id:s}}),select:e=>e.data,enabled:n});return(0,j.jsxs)(U.v,{shadow:"md",onChange:r?void 0:c,position:i,disabled:r,children:[(0,j.jsx)(U.v.Target,{children:a}),(0,j.jsxs)(U.v.Dropdown,{children:[o&&Array.from({length:5},((e,s)=>(0,j.jsx)(U.v.Item,{children:(0,j.jsx)(Z.O,{w:100,h:20,bg:"cyan.6"})},s))),!o&&(null==d?void 0:d.transitions.map((e=>(0,j.jsx)(U.v.Item,{onClick:()=>t(e),value:e.name,children:e.name},e.id))))]})]})};var R=t(93513);const A=e=>{const{id:s,queryKey:t,children:a,position:i,disabled:r,idxPage:n,idxIssue:l,onChange:c}=e,d=(0,q.NL)(),{mutate:o}=(0,N.D)({mutationFn:e=>u.b.post("/change-status-task",{taskId:s,transitionId:e.id}),onMutate:async e=>{await d.cancelQueries({queryKey:[t]});const s=d.getQueryData([t]);return d.setQueryData([t],(s=>"issues"in s?(0,R.Uy)(s,(s=>{s.issues[l].fields.status=e.to})):(0,R.Uy)(s,(s=>{s.pages[n].issues[l].fields.status=e.to})))),"function"==typeof c&&c(),{oldState:s}},onError:(e,s,a)=>{d.setQueryData([t],a.oldState)}});return(0,j.jsx)(z,{id:s,position:i,disabled:r,onChange:e=>o(e),children:a})};var J=t(27484),M=t.n(J);const E=()=>{const[e,s]=(0,l.useState)(M()().startOf("day")),t=e.format("HH:mm:ss");return(0,l.useEffect)((()=>{let e;return e=setInterval((()=>{s((e=>e.add(1,"second")))}),1e3),()=>clearInterval(e)}),[]),(0,j.jsx)(Q.C,{mb:10,size:"xl",radius:"sm",variant:"filled",children:t})},H=e=>{const{fields:s,id:t,idxIssue:i,setSearchParams:r}=e,c=(0,q.NL)(),[d,o]=(0,l.useState)(!1);return(0,j.jsxs)(T.Z,{shadow:"sm",radius:"md",bg:"teal.0",mb:"sm",withBorder:!0,children:[(0,j.jsx)(E,{}),(0,j.jsxs)(C.Z,{mb:10,justify:"space-between",children:["indeterminate"!==s.status.statusCategory.key&&(0,j.jsx)(L.b,{className:"w-[100%]",variant:"light",color:"red",title:"Warning!",icon:(0,j.jsx)(_.Z,{}),children:'This task is not in the "In progress" status please change its status. However, time continues to be logged for it.'}),(0,j.jsx)(a.D,{order:5,children:s.summary}),(0,j.jsxs)(Q.C,{color:"blue",className:"flex-row",children:[(0,j.jsx)("span",{className:"mr-[0.5rem]",children:O(s.timespent)}),(0,j.jsx)("span",{className:"mr-[0.5rem]",children:"/"}),(0,j.jsx)("span",{children:O(s.timeoriginalestimate)})]})]}),(0,j.jsxs)(C.Z,{justify:"space-between",children:[(0,j.jsx)(A,{id:t,idxIssue:i,queryKey:"tasks tracking",children:(0,j.jsx)(n.z,{variant:"outline",size:"xs",children:s.status.name})}),d?(0,j.jsx)(F.a,{size:"sm"}):(0,j.jsx)(D.A,{variant:"light",children:(0,j.jsx)(K.Z,{onClick:async()=>{r((e=>{const s=e.get("keysTaskTracking").split(",").map((e=>parseInt(e,10))),a=s.indexOf(Number(t));-1!==a&&s.splice(a,1);return{keysTaskTracking:s.join(",")}})),g.getState().updateJQL(),o(!0),await c.cancelQueries({queryKey:["tasks"]}),await c.invalidateQueries({queryKey:["tasks"]}),c.setQueryData(["tasks tracking"],(e=>(0,R.Uy)(e,(e=>{e.issues.splice(i,1)})))),o(!1)},className:"cursor-pointer [&_path]:fill-[var(--mantine-color-violet-5)]"})})]})]},t)},B=(0,l.memo)(H),V=()=>{const[,e]=(0,P.lr)(),{data:s}=(0,I.a)(h());return(0,j.jsx)(j.Fragment,{children:null==s?void 0:s.issues.map(((s,t)=>(0,j.jsx)(B,{idxIssue:t,fields:s.fields,id:s.id,setSearchParams:e},s.id)))})};var W=t(87311);const G=e=>{const{fields:s,id:t,setSearchParams:i,idxPage:r,idxIssue:l}=e,c=(0,q.NL)(),d=()=>{i((e=>{let s=t;for(const t of e.values())t&&(s+=",".concat(t));return{keysTaskTracking:s}})),g.getState().updateJQL(),c.setQueryData(["tasks tracking"],(e=>{const s=c.getQueryData(["tasks"]);return(0,R.Uy)(e,(e=>{s&&e.issues.unshift(s.pages[r].issues[l])}))})),c.setQueryData(["tasks"],(e=>(0,R.Uy)(e,(e=>{e.pages[r].issues.splice(l,1)}))))};return(0,j.jsxs)(T.Z,{shadow:"sm",radius:"md",mb:"sm",withBorder:!0,children:[(0,j.jsxs)(C.Z,{mb:10,justify:"space-between",children:[(0,j.jsx)(a.D,{order:5,children:s.summary}),(0,j.jsxs)(Q.C,{color:"blue",className:"flex-row",children:[(0,j.jsx)("span",{className:"mr-[0.5rem]",children:O(s.timespent)}),(0,j.jsx)("span",{className:"mr-[0.5rem]",children:"/"}),(0,j.jsx)("span",{children:O(s.timeoriginalestimate)})]})]}),(0,j.jsxs)(C.Z,{justify:"space-between",children:[(0,j.jsx)(A,{id:t,idxPage:r,idxIssue:l,queryKey:"tasks",children:(0,j.jsx)(n.z,{variant:"outline",size:"xs",children:s.status.name})}),(0,j.jsx)(A,{id:t,idxPage:r,idxIssue:l,queryKey:"tasks",position:"left",onChange:()=>d(),disabled:"indeterminate"===s.status.statusCategory.key,children:(0,j.jsx)(W.Z,{className:"cursor-pointer [&_path]:fill-[var(--mantine-color-violet-5)]",..."indeterminate"===s.status.statusCategory.key&&{onClick:d}})})]})]},t)},Y=(0,l.memo)(G),X=()=>{const[,e]=(0,P.lr)(),{data:s}=(0,r.N)(p());return(0,j.jsx)(j.Fragment,{children:null==s?void 0:s.pages.map(((s,t)=>s.issues.map(((s,a)=>(0,j.jsx)(Y,{idxPage:t,idxIssue:a,fields:s.fields,id:s.id,setSearchParams:e},s.id)))))})},$=()=>(0,j.jsxs)(j.Fragment,{children:[(0,j.jsx)(a.D,{mb:10,order:2,children:"Tasks"}),(0,j.jsx)(w,{}),(0,j.jsx)(V,{}),(0,j.jsx)(X,{}),(0,j.jsx)(x,{})]}),ee="___TimeTracking___",se=e=>async()=>{let s="";try{const t=await u.b.get("/filters",{params:{filterValue:ee}});if(t.data.values.length>0){const e=t.data.values[0].id,a=await u.b.get("/filter-details",{params:{id:e}});g.getState().setFilterId(e);const i=g.getState().updateJQL(a.data.jql);a.data.jql!==i&&u.b.put("/filter-details",{jql:i},{params:{id:e}}).catch((()=>{})),s=i}else{const e=g.getState().getSearchParamsIds();s=(await u.b.post("/filter-details",{name:ee,description:"",jql:e?"NOT key in (".concat(e,")"):""})).data.jql}g.getState().updateJQL(s),e.prefetchInfiniteQuery(p()),e.prefetchQuery(h())}catch(e){}return!0}}}]);