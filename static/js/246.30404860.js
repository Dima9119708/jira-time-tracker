"use strict";(self.webpackChunkjira_time_tracker=self.webpackChunkjira_time_tracker||[]).push([[246],{73246:(e,a,s)=>{s.d(a,{TasksPage:()=>U,loaderTasks:()=>A});var t=s(74064),i=s(81083);const r=e=>(0,t.t)({queryKey:["tasks"],queryFn:async a=>(await i.b.get("/tasks",{params:{jql:e,startAt:5*a.pageParam,maxResults:5},signal:a.signal})).data,getNextPageParam:(e,a,s,t)=>e.issues.length>0?s+1:null,initialPageParam:0});var n=s(59908),l=s(60235),c=s(42708),d=s(82792),o=s(67294),u=s(2321),m=s(89250),h=s(85893);const g=()=>{const e=(0,m.f_)(),{ref:a,inView:s}=(0,c.YD)(),{isFetching:t,isFetchingNextPage:i,hasNextPage:l,fetchNextPage:g}=(0,n.N)(r(e));return(0,o.useEffect)((()=>{s&&!t&&g()}),[s,t]),(0,h.jsxs)(d.z,{variant:"light",color:"blue",onClick:()=>g(),fullWidth:!0,children:[i?"Loading more...":l?"Load More":"Nothing more to load",(0,h.jsx)("span",{ref:a,className:(0,u.cn)("invisible",{hidden:i})})]})},p=(0,o.memo)(g);var y=s(29855),x=s(85453),j=s(39448),k=s(87311),f=s(30202);const b=e=>{const a=Math.floor(e/60),s=Math.floor(a/60);return"".concat(String(s).padStart(2,"0"),":").concat(String(a%60).padStart(2,"0"))};var v=s(96205),N=s(80830),_=s(89341),q=s(78551);const w=e=>{const{id:a,onChange:s,children:t,position:r="bottom-start",disabled:n}=e,[l,c]=(0,o.useState)(!1),{data:d,isLoading:u}=(0,q.a)({queryKey:["statuses task",a],queryFn:()=>i.b.get("/statuses-task",{params:{id:a}}),select:e=>e.data,enabled:l});return(0,h.jsxs)(N.v,{shadow:"md",onChange:n?void 0:c,position:r,disabled:n,children:[(0,h.jsx)(N.v.Target,{children:t}),(0,h.jsxs)(N.v.Dropdown,{children:[u&&Array.from({length:5},((e,a)=>(0,h.jsx)(N.v.Item,{children:(0,h.jsx)(_.O,{w:100,h:20,bg:"cyan.6"})},a))),!u&&(null==d?void 0:d.transitions.map((e=>(0,h.jsx)(N.v.Item,{onClick:()=>s(e),value:e.name,children:e.name},e.id))))]})]})};var T=s(93513);const P=e=>{const{id:a,queryKey:s,children:t,position:r,disabled:n,idxPage:l,idxIssue:c,onChange:d}=e,o=(0,f.NL)(),{mutate:u}=(0,v.D)({mutationFn:e=>i.b.post("/change-status-task",{taskId:a,transitionId:e.id}),onMutate:async e=>{await o.cancelQueries({queryKey:[s]});const a=o.getQueryData([s]);return o.setQueryData([s],(a=>(0,T.Uy)(a,(a=>{a.pages[l].issues[c].fields.status=e.to})))),"function"==typeof d&&d(),{oldState:a}},onError:(e,a,t)=>{o.setQueryData([s],t.oldState)}});return(0,h.jsx)(w,{id:a,position:r,disabled:n,onChange:e=>u(e),children:t})},C=e=>{const{fields:a,id:s,setSearchParams:t,idxPage:i,idxIssue:r}=e,n=(0,f.NL)(),c=()=>{t((e=>{let a=s;for(const s of e.values())s&&(a+=",".concat(s));return{keysTaskTracking:a}})),n.setQueryData(["tasks"],(e=>(0,T.Uy)(e,(e=>{e.pages[i].issues.splice(r,1)}))))};return(0,h.jsxs)(y.Z,{shadow:"sm",radius:"md",mb:"sm",withBorder:!0,children:[(0,h.jsxs)(x.Z,{mb:10,justify:"space-between",children:[(0,h.jsx)(l.D,{order:5,children:a.summary}),(0,h.jsxs)(j.C,{color:"blue",className:"flex-row",children:[(0,h.jsx)("span",{className:"mr-[0.5rem]",children:b(a.timespent)}),(0,h.jsx)("span",{className:"mr-[0.5rem]",children:"/"}),(0,h.jsx)("span",{children:b(a.timeoriginalestimate)})]})]}),(0,h.jsxs)(x.Z,{justify:"space-between",children:[(0,h.jsx)(P,{id:s,idxPage:i,idxIssue:r,queryKey:"tasks",children:(0,h.jsx)(d.z,{variant:"outline",size:"xs",children:a.status.name})}),(0,h.jsx)(P,{id:s,idxPage:i,idxIssue:r,queryKey:"tasks",position:"left",onChange:()=>c(),disabled:"indeterminate"===a.status.statusCategory.key,children:(0,h.jsx)(k.Z,{className:"cursor-pointer [&_path]:fill-[var(--mantine-color-violet-5)]",..."indeterminate"===a.status.statusCategory.key&&{onClick:c}})})]})]},s)},S=(0,o.memo)(C);var D=s(79655),F=s(21760),I=s(40327);const L=async e=>{const a=await i.b.post("/autocomplete",{includeCollapsedFields:!0},{params:{url:e}});return{jqlFields:a.data.visibleFieldNames,jqlFunctions:a.data.visibleFunctionNames}},O=async e=>(await i.b.get("/autocomplete",{params:{url:e}})).data,K=(e,a)=>{if(a){const s="NOT key in (".concat(a,")");return e.includes("NOT key in")?e.replace(/NOT\skey\s+in\s+\(\d+(,\s*\d+)*\)/,s).trim():e.trim().length>0?"".concat(s," AND ").concat(e.trim()):s}return e.replace(/NOT\skey\s+in\s+\(\d+(,\s*\d+)*\)\s*AND/g,"").replace(/NOT\skey\s+in\s+\(\d+(,\s*\d+)*\)/g,"").trim()},Q=e=>{const{className:a,onSearch:s,query:t}=e,i=(0,I.R)("autocomplete",L,O);return(0,h.jsx)("div",{className:(0,u.cn)("mb-[1.5rem] [&_div_div:nth-child(1)]:bg-[var(--mantine-color-default)]",a),children:(0,h.jsx)(F.L,{analyticsSource:"autocomplete",query:t,onSearch:(e,a)=>{if(s&&0===a.errors.length){const t=new URL(document.URL).searchParams.get("keysTaskTracking"),i=K(e,t);s(i,a)}},autocompleteProvider:i,locale:"en"})})},R=(0,o.memo)(Q),U=()=>{const e=(0,m.f_)(),[,a]=(0,D.lr)(),{data:s}=(0,n.N)(r(e));return(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(l.D,{mb:10,order:2,children:"Tasks"}),(0,h.jsx)(R,{query:e,onSearch:()=>{}}),null==s?void 0:s.pages.map(((e,s)=>e.issues.map(((e,t)=>(0,h.jsx)(S,{idxPage:s,idxIssue:t,fields:e.fields,id:e.id,setSearchParams:a},e.id))))),(0,h.jsx)(p,{})]})},A=e=>async a=>{let{request:s}=a,t="";try{const a=await i.b.get("/filters",{params:{filterValue:"___TimeTracking___"}}),n=new URL(s.url).searchParams.get("keysTaskTracking");if(a.data.values.length>0){const e=await i.b.get("/filter-details",{params:{id:a.data.values[0].id}}),s=K(e.data.jql,n);e.data.jql!==s&&i.b.put("/filter-details",{jql:s},{params:{id:a.data.values[0].id}}),t=s}else{t=(await i.b.post("/filter-details",{name:"___TimeTracking___",description:"",jql:n?"NOT key in (".concat(n,")"):""})).data.jql}e.prefetchInfiniteQuery(r(t))}catch(e){}return t}}}]);